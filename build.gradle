import org.jetbrains.intellij.platform.gradle.TestFrameworkType

plugins {
    id 'java'
    id 'org.jetbrains.intellij.platform' version '2.5.0'
}

group = 'cn.sticki'
version = '1.0.0'

repositories {
    mavenCentral()
    intellijPlatform {
        defaultRepositories()
    }
}

// Configure IntelliJ Platform Gradle Plugin
// Read more: https://plugins.jetbrains.com/docs/intellij/tools-intellij-platform-gradle-plugin.html
dependencies {
    intellijPlatform {
        // Target IntelliJ IDEA 2023.2+ as per requirements
        create('IU', '2023.2')
        
        // Required plugins for SpEL support
        bundledPlugin('com.intellij.java')
        bundledPlugin('org.intellij.intelliLang')
        bundledPlugin('com.intellij.spring')

        // IntelliJ Platform testing infrastructure
        testFramework(TestFrameworkType.Platform.INSTANCE)
    }
    
    // Testing dependencies
    testImplementation('org.junit.jupiter:junit-jupiter:5.9.3')
    testRuntimeOnly('org.junit.platform:junit-platform-launcher')

    // JUnit 3 for IntelliJ Platform tests
    testImplementation('junit:junit:3.8.1')

    // Property-based testing library
    testImplementation('org.quicktheories:quicktheories:0.26')
}

intellijPlatform {
    pluginConfiguration {
        name = 'SpEL Validator Support'
        version = project.version
        
        ideaVersion {
            sinceBuild = '232'  // 2023.2
            untilBuild = ''     // No upper limit
        }

        changeNotes = '''
            <h3>1.0.0</h3>
            <ul>
                <li>Initial release</li>
                <li>SpEL language injection for SpEL Validator annotations</li>
                <li>Field completion for #this context</li>
                <li>Field reference resolution and navigation</li>
                <li>Field rename refactoring support</li>
                <li>Field existence error checking</li>
            </ul>
        '''.stripIndent()
    }
}

tasks.withType(JavaCompile) {
    sourceCompatibility = '17'
    targetCompatibility = '17'
    options.encoding = 'UTF-8'
}

tasks.named('test') {
    useJUnitPlatform()
}
